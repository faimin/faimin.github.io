<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Block捕获原理探究 - Zero.D.Saber</title><meta name=Description content="探索block变量捕获的原理"><meta property="og:title" content="Block捕获原理探究"><meta property="og:description" content="探索block变量捕获的原理"><meta property="og:type" content="article"><meta property="og:url" content="https://github.com/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"><meta property="og:image" content="https://github.com/logo/avatar.gif"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-08-17T12:10:41+08:00"><meta property="article:modified_time" content="2022-08-26T23:27:25+08:00"><meta property="og:site_name" content="Zero.D.Saber的小屋"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://github.com/logo/avatar.gif"><meta name=twitter:title content="Block捕获原理探究"><meta name=twitter:description content="探索block变量捕获的原理"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/logo/avatar.gif><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://github.com/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/><link rel=prev href=https://github.com/faimin/faimin.github.io/tree/gh-pages/codetips/><link rel=next href=https://github.com/faimin/faimin.github.io/tree/gh-pages/promise%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/><link rel=stylesheet href=/faimin/faimin.github.io/tree/gh-pages/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Block捕获原理探究","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/github.com\/faimin\/faimin.github.io\/tree\/gh-pages\/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6\/"},"image":["https:\/\/github.com\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"iOS, block","wordcount":4784,"url":"https:\/\/github.com\/faimin\/faimin.github.io\/tree\/gh-pages\/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6\/","datePublished":"2018-08-17T12:10:41+08:00","dateModified":"2022-08-26T23:27:25+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Zero.D.Saber","logo":"https:\/\/github.com\/images\/avatar.png"},"author":{"@type":"Person","name":"Zero.D.Saber"},"description":"探索block变量捕获的原理"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/faimin/faimin.github.io/tree/gh-pages/ title=Zero.D.Saber>Zero.D.Saber's Notes</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/posts/>所有文章 </a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/tags/>标签 </a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/categories/>分类 </a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/categories/documentation/>文档 </a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/about/whoami>关于 </a><a class=menu-item href=https://github.com/faimin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title=选择语言><i class="fa fa-globe" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ selected>简体中文</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/faimin/faimin.github.io/tree/gh-pages/ title=Zero.D.Saber>Zero.D.Saber's Notes</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/posts/ title>所有文章</a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/tags/ title>标签</a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/categories/ title>分类</a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/categories/documentation/ title>文档</a><a class=menu-item href=/faimin/faimin.github.io/tree/gh-pages/about/whoami title>关于</a><a class=menu-item href=https://github.com/faimin title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Block捕获原理探究</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/faimin title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Zero.D.Saber</a></span>&nbsp;<span class=post-category>收录于 <a href=/faimin/faimin.github.io/tree/gh-pages/categories/%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/><i class="far fa-folder fa-fw" aria-hidden=true></i>实现原理</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2018-08-17>2018-08-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 4784 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 10 分钟&nbsp;<span id=/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ class=leancloud_visitors data-flag-title=Block捕获原理探究>
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class=featured-image><img class=lazyload src=/faimin/faimin.github.io/tree/gh-pages/svg/loading.min.svg data-src=/images/block/milim.jpg data-srcset="/images/block/milim.jpg, /images/block/milim.jpg 1.5x, /images/block/milim.jpg 2x" data-sizes=auto alt=/images/block/milim.jpg title=探索block变量捕获的原理></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1不加__block的情况>1、不加__block的情况:</a></li><li><a href=#2添加__block的情况>2、添加__block的情况:</a></li><li><a href=#3静态变量>3、静态变量:</a></li><li><a href=#4全局变量>4、全局变量:</a></li><li><a href=#总结>总结:</a><ul><li><ul><li><a href=#局部变量>局部变量：</a></li><li><a href=#静态变量>静态变量：</a></li><li><a href=#全局变量或-全局静态变量>全局变量（或 全局静态变量）：</a></li><li><a href=#其他>其他</a></li></ul></li></ul></li><li><a href=#推荐文章>推荐文章：</a></li><li><a href=#参考文章>参考文章:</a></li></ul></nav></div></div><div class=content id=content><p>探索<code>block</code>捕获外界变量的原理</p><p>在此之前先介绍一下<strong>block 基本语法</strong>：</p><p><figure><a class=lightgallery href=/images/block/BlockSyntax.png title=/images/block/BlockSyntax.png data-thumbnail=/images/block/BlockSyntax.png data-sub-html="<h2>BlockSyntax</h2>"><img class=lazyload src=/faimin/faimin.github.io/tree/gh-pages/svg/loading.min.svg data-src=/images/block/BlockSyntax.png data-srcset="/images/block/BlockSyntax.png, /images/block/BlockSyntax.png 1.5x, /images/block/BlockSyntax.png 2x" data-sizes=auto alt=/images/block/BlockSyntax.png></a><figcaption class=image-caption>BlockSyntax</figcaption></figure></p></br><details open><summary>Block Syntax</summary><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=c1>// Block as a local variable
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>returnType</span> <span class=p>(</span><span class=o>^</span><span class=n>blockName</span><span class=p>)(</span><span class=n>parameterTypes</span><span class=p>)</span> <span class=o>=</span> <span class=o>^</span><span class=n>returnType</span><span class=p>(</span><span class=n>parameters</span><span class=p>)</span> <span class=p>{...};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Block as a property
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>@property</span> <span class=p>(</span><span class=k>nonatomic</span><span class=p>,</span> <span class=k>copy</span><span class=p>)</span> <span class=n>returnType</span> <span class=p>(</span><span class=o>^</span><span class=n>blockName</span><span class=p>)(</span><span class=n>parameterTypes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Block as a method parameter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>someMethodThatTakesABlock:</span><span class=p>(</span><span class=n>returnType</span> <span class=p>(</span><span class=o>^</span><span class=p>)(</span><span class=n>parameterTypes</span><span class=p>))</span><span class=nv>blockName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Block as an argument to a method call
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>[</span><span class=n>someObject</span> <span class=nl>someMethodThatTakesABlock</span><span class=p>:</span> <span class=o>^</span><span class=n>returnType</span> <span class=p>(</span><span class=n>parameters</span><span class=p>)</span> <span class=p>{...}];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Block as typedef
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=nf>returnType</span> <span class=p>(</span><span class=o>^</span><span class=n>TypeName</span><span class=p>)(</span><span class=n>parameterTypes</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>TypeName</span> <span class=n>blockName</span> <span class=o>=</span> <span class=o>^</span><span class=n>returnType</span><span class=p>(</span><span class=n>parameters</span><span class=p>)</span> <span class=p>{...};</span>
</span></span></code></pre></td></tr></table></div></div></details><p>对<code>Object-C</code>文件执行 <code>xcrun -sdk iphonesimulator clang -fobjc-arc -fobjc-runtime=ios -rewrite-objc fileName.m</code> 操作来获取伪代码，仅供技术探究。</p><p>先把<code>__block_impl</code>结构体拿出来放在最前面，最终<code>block</code>调用时都会被强转成这种类型，下面好多地方会用到。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>__block_impl</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>isa</span><span class=p>;</span>        
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>Flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>Reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>FuncPtr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><ul><li><code>isa</code>指针：指向一个类对象，在非<code>GC</code>模式下有三种类型：_<code>NSConcreteStackBlock</code>、<code>_NSConcreteGlobalBlock</code>、<code>_NSConcreteMallocBlock</code>；</li><li><code>Flags</code>：<code>block</code>的负载信息（引用计数和类型信息），按位存储；</li><li><code>Reserved</code>：保留变量；</li><li><code>FuncPtr</code>：指向<code>block</code>函数地址的指针。</li><li><code>descriptor</code>：是用于描述当前这个 <code>block</code> 的附加信息的，包括结构体的大小，需要 <code>capture</code> 和 <code>dispose</code> 的变量列表等。结构体大小需要保存是因为，每个 <code>block</code> 因为会 <code>capture</code> 一些变量，这些变量会加到 <code>__main_block_impl_0</code> 这个结构体中，使其体积变大。</li></ul></blockquote><p>接下来进入正题：</p><blockquote><p>p.s：以下<code>Objective-C</code>的代码都处在<code>ARC</code>环境下</p></blockquote><h2 id=1不加__block的情况>1、不加__block的情况:</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=cp>#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>@autoreleasepool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mutArr</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSMutableArray</span> <span class=n>array</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>mutArr</span> <span class=nl>addObject</span><span class=p>:</span><span class=mi>@2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>block</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>执行<code>clang</code>操作后的<code>C++</code>代码:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 定义block的结构体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__block_impl</span> <span class=n>impl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__main_block_desc_0</span><span class=o>*</span> <span class=n>Desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mutArr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__main_block_impl_0</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>_mutArr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>mutArr</span><span class=p>(</span><span class=n>_mutArr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>isa</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_NSConcreteStackBlock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>Flags</span> <span class=o>=</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>FuncPtr</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Desc</span> <span class=o>=</span> <span class=n>desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 以下为调用`block`时执行的方法
</span></span></span><span class=line><span class=cl><span class=c1>// 此`mutArr`是在最初定义`block`时 为结构体传进去的局部变量`mutArr`的值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_func_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=o>*</span><span class=n>__cself</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// bound by copy:这里的注释表示，block对它引用的局部变量做了只读拷贝，也就是说block引用的是局部变量的副本。
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mutArr</span> <span class=o>=</span> <span class=n>__cself</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>;</span> <span class=c1>// bound by copy
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>   <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>ObjectType</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>mutArr</span><span class=p>,</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;addObject:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>id</span><span class=p>)((</span><span class=n>NSNumber</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>Class</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=kt>int</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)(</span><span class=n>objc_getClass</span><span class=p>(</span><span class=s>&#34;NSNumber&#34;</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;numberWithInt:&#34;</span><span class=p>),</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// block的copy函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_copy_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_Block_object_assign</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>dst</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>,</span> <span class=mi>3</span><span class=cm>/*BLOCK_FIELD_IS_OBJECT*/</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_dispose_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_Block_object_dispose</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>,</span> <span class=mi>3</span><span class=cm>/*BLOCK_FIELD_IS_OBJECT*/</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>Block_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>copy</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>dispose</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>__main_block_desc_0_DATA</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=p>),</span> <span class=n>__main_block_copy_0</span><span class=p>,</span> <span class=n>__main_block_dispose_0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=cm>/* @autoreleasepool */</span> <span class=p>{</span> <span class=n>__AtAutoreleasePool</span> <span class=n>__autoreleasepool</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mutArr</span> <span class=o>=</span> <span class=p>((</span><span class=n>NSMutableArray</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>objc_getClass</span><span class=p>(</span><span class=s>&#34;NSMutableArray&#34;</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;array&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 可以看出block变量实际上就是一个指向结构体`__main_block_impl_0`的指针,而结构体的第三个元素是局部变量mutArr的值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 此处捕获的直接就是`mutArr`局部变量
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=o>&amp;</span><span class=n>__main_block_impl_0</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>__main_block_func_0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>__main_block_desc_0_DATA</span><span class=p>,</span> <span class=n>mutArr</span><span class=p>,</span> <span class=mi>570425344</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 下面调用`block`的方法实质其实是: 指向结构体的指针`block`访问其`FuncPtr`元素(即,在定义block时为`FuncPtr`元素传进去的`__main_block_func_0`方法)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>))((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>FuncPtr</span><span class=p>)((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>IMAGE_INFO</span> <span class=p>{</span> <span class=kt>unsigned</span> <span class=n>version</span><span class=p>;</span> <span class=kt>unsigned</span> <span class=n>flag</span><span class=p>;</span> <span class=p>}</span> <span class=n>_OBJC_IMAGE_INFO</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span> <span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=2添加__block的情况>2、添加__block的情况:</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=cp>#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>@autoreleasepool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>__block</span> <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mutArr</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSMutableArray</span> <span class=n>array</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>mutArr</span> <span class=nl>addObject</span><span class=p>:</span><span class=mi>@2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>mutArr</span> <span class=nl>addObject</span><span class=p>:</span><span class=s>@&#34;hello&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>block</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>执行<code>clang</code>后的<code>C++</code>代码:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 由下面的代码可知: `__block`的作用就是定义一个新的结构体来包裹原来的变量
</span></span></span><span class=line><span class=cl><span class=c1>// 定义一个保存变量的结构体 （被__block标记的变量会被转化为这种格式的结构体对象）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>__Block_byref_mutArr_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>__isa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__Block_byref_mutArr_0</span> <span class=o>*</span><span class=n>__forwarding</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=kt>int</span> <span class=n>__flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=kt>int</span> <span class=n>__size</span><span class=p>;</span>
</span></span><span class=line><span class=cl> <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>__Block_byref_id_object_copy</span><span class=p>)(</span><span class=kt>void</span><span class=o>*</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>__Block_byref_id_object_dispose</span><span class=p>)(</span><span class=kt>void</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl> <span class=n>NSMutableArray</span> <span class=o>*</span><span class=n>mutArr</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// block 结构体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__block_impl</span> <span class=n>impl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__main_block_desc_0</span><span class=o>*</span> <span class=n>Desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 包含捕获的局部变量的结构体指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>__Block_byref_mutArr_0</span> <span class=o>*</span><span class=n>mutArr</span><span class=p>;</span> <span class=c1>// by ref
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>__main_block_impl_0</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=n>__Block_byref_mutArr_0</span> <span class=o>*</span><span class=n>_mutArr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>mutArr</span><span class=p>(</span><span class=n>_mutArr</span><span class=o>-&gt;</span><span class=n>__forwarding</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>isa</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_NSConcreteStackBlock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>Flags</span> <span class=o>=</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>FuncPtr</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Desc</span> <span class=o>=</span> <span class=n>desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 在block内部对`mutArr`操作 (block回调时执行的函数)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_func_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=o>*</span><span class=n>__cself</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 拿到 包含捕获的局部变量 的结构体指针
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=n>__Block_byref_mutArr_0</span> <span class=o>*</span><span class=n>mutArr</span> <span class=o>=</span> <span class=n>__cself</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>;</span> <span class=c1>// bound by ref
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// 通过上面的结构体指针一步步拿到`mutArr`数组
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>ObjectType</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)(</span><span class=n>mutArr</span><span class=o>-&gt;</span><span class=n>__forwarding</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;addObject:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>id</span><span class=p>)((</span><span class=n>NSNumber</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>Class</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=kt>int</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)(</span><span class=n>objc_getClass</span><span class=p>(</span><span class=s>&#34;NSNumber&#34;</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;numberWithInt:&#34;</span><span class=p>),</span> <span class=mi>2</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_copy_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_Block_object_assign</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>dst</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>,</span> <span class=mi>8</span><span class=cm>/*BLOCK_FIELD_IS_BYREF*/</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_dispose_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_Block_object_dispose</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>,</span> <span class=mi>8</span><span class=cm>/*BLOCK_FIELD_IS_BYREF*/</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>Block_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>copy</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>dispose</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>__main_block_desc_0_DATA</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=p>),</span> <span class=n>__main_block_copy_0</span><span class=p>,</span> <span class=n>__main_block_dispose_0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// main函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=cm>/* @autoreleasepool */</span> <span class=p>{</span> <span class=n>__AtAutoreleasePool</span> <span class=n>__autoreleasepool</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 这里可以看到结构体中的 __forwarding 指针其实指向的就是其自身
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>__attribute__</span><span class=p>((</span><span class=n>__blocks__</span><span class=p>(</span><span class=n>byref</span><span class=p>)))</span> <span class=n>__Block_byref_mutArr_0</span> <span class=n>mutArr</span> <span class=o>=</span> <span class=p>{(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=mi>0</span><span class=p>,(</span><span class=n>__Block_byref_mutArr_0</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>mutArr</span><span class=p>,</span> <span class=mi>33554432</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>__Block_byref_mutArr_0</span><span class=p>),</span> <span class=n>__Block_byref_id_object_copy_131</span><span class=p>,</span> <span class=n>__Block_byref_id_object_dispose_131</span><span class=p>,</span> <span class=p>((</span><span class=n>NSMutableArray</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>objc_getClass</span><span class=p>(</span><span class=s>&#34;NSMutableArray&#34;</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;array&#34;</span><span class=p>))};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 与不加__block差不多,`block`变量还是一个指向`__main_block_impl_0`结构体的指针,区别在于第三个参数变了. 第三个参数是包含局部变量`mutArr`的结构体指针.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 即block捕获的是持有`mutArr`的结构体指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=o>&amp;</span><span class=n>__main_block_impl_0</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>__main_block_func_0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>__main_block_desc_0_DATA</span><span class=p>,</span> <span class=p>(</span><span class=n>__Block_byref_mutArr_0</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>mutArr</span><span class=p>,</span> <span class=mi>570425344</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 在block外部对`mutArr`操作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 此处对`mutArr`数组对象进行操作,获取`mutArr`也是和`block`内部的获取方法一样,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 都是通过持有`mutArr`的结构体一步步获取到`mutArr`数组,
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 这里要经过 __forwarding 来获取`mutArr`的原因是：
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// __block 标记的变量有可能被copy到堆上，__forwarding 的作用就是在被copy到堆上时修改指向，使栈和堆上的 __forwarding 都指向堆上的那个副本，这样就保证了block内外操作的都是同一份内存。
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 具体的copy实现可以参见下面的 `_Block_byref_copy` 函数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 所以,在block内外,操作的都是同一个`mutArr`对象.都是通过包含`mutArr`对象的`__Block_byref_mutArr_0`结构体对其进行间接操作处理的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 这也就是为什么添加`__block`后还能改变原来的对象的原因
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// PS: 当我们用__block 标记一个变量以后，当我们用到这个变量时都不是直接使用这个变量了，而是变成了通过`__Block_byref`来操作这个变量
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>ObjectType</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)(</span><span class=n>mutArr</span><span class=p>.</span><span class=n>__forwarding</span><span class=o>-&gt;</span><span class=n>mutArr</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;addObject:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>id</span><span class=p>)(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_b07809_mi_0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>))((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>FuncPtr</span><span class=p>)((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>IMAGE_INFO</span> <span class=p>{</span> <span class=kt>unsigned</span> <span class=n>version</span><span class=p>;</span> <span class=kt>unsigned</span> <span class=n>flag</span><span class=p>;</span> <span class=p>}</span> <span class=n>_OBJC_IMAGE_INFO</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// __block 变量被copy到堆上时的具体实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=nf>_Block_byref_copy</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=n>src</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_REFCOUNT_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// src points to stack
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=n>copy</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>isa</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// byref value 4 is logical refcount of 2: one for caller, one for stack
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>=</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>|</span> <span class=n>BLOCK_BYREF_NEEDS_FREE</span> <span class=o>|</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 堆上的forwarding指向其自身
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>forwarding</span> <span class=o>=</span> <span class=n>copy</span><span class=p>;</span> <span class=c1>// patch heap copy to point to itself
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 栈上的forwarding指向copy到堆上的副本
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span> <span class=o>=</span> <span class=n>copy</span><span class=p>;</span>  <span class=c1>// patch stack to point to heap copy
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>copy</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_HAS_COPY_DISPOSE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Trust copy helper to copy everything of interest
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// If more than one field shows up in a byref block this is wrong XXX
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=n>src2</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=p>)(</span><span class=n>src</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=n>copy2</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_2</span> <span class=o>*</span><span class=p>)(</span><span class=n>copy</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>copy2</span><span class=o>-&gt;</span><span class=n>byref_keep</span> <span class=o>=</span> <span class=n>src2</span><span class=o>-&gt;</span><span class=n>byref_keep</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>copy2</span><span class=o>-&gt;</span><span class=n>byref_destroy</span> <span class=o>=</span> <span class=n>src2</span><span class=o>-&gt;</span><span class=n>byref_destroy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_LAYOUT_EXTENDED</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>struct</span> <span class=nc>Block_byref_3</span> <span class=o>*</span><span class=n>src3</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_3</span> <span class=o>*</span><span class=p>)(</span><span class=n>src2</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>struct</span> <span class=nc>Block_byref_3</span> <span class=o>*</span><span class=n>copy3</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nc>Block_byref_3</span><span class=o>*</span><span class=p>)(</span><span class=n>copy2</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>copy3</span><span class=o>-&gt;</span><span class=n>layout</span> <span class=o>=</span> <span class=n>src3</span><span class=o>-&gt;</span><span class=n>layout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=o>*</span><span class=n>src2</span><span class=o>-&gt;</span><span class=n>byref_keep</span><span class=p>)(</span><span class=n>copy</span><span class=p>,</span> <span class=n>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Bitwise copy.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// This copy includes Block_byref_3, if any.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>memmove</span><span class=p>(</span><span class=n>copy</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>src</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>-</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>src</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// already copied to heap
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>&amp;</span> <span class=n>BLOCK_BYREF_NEEDS_FREE</span><span class=p>)</span> <span class=o>==</span> <span class=n>BLOCK_BYREF_NEEDS_FREE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>latching_incr_int</span><span class=p>(</span><span class=o>&amp;</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=o>-&gt;</span><span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>src</span><span class=o>-&gt;</span><span class=n>forwarding</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>虽然<code>NSMutableArray</code>前面加不加<code>__block</code>，都不会影响往数组中添加数据，但是当在<code>block</code>中给<code>mutArr</code>重新赋值的时候就有区别了。</p><p><figure><a class=lightgallery href=/images/block/blockTest1.png title=/images/block/blockTest1.png data-thumbnail=/images/block/blockTest1.png data-sub-html="<h2>blockTest</h2>"><img class=lazyload src=/faimin/faimin.github.io/tree/gh-pages/svg/loading.min.svg data-src=/images/block/blockTest1.png data-srcset="/images/block/blockTest1.png, /images/block/blockTest1.png 1.5x, /images/block/blockTest1.png 2x" data-sizes=auto alt=/images/block/blockTest1.png></a><figcaption class=image-caption>blockTest</figcaption></figure></p><p>如果你想对<code>mutArr</code>变量重新赋一个新的<code>array</code>实例，改变原变量的指针，那么不加<code>_block</code>是不行的，因为<code>block</code>捕获的是对象的地址，重新赋值，指针的指向就变了。但是如果只是单纯的<code>add</code>一个数据进去实际上改变的是变量所指的那个<code>mutArr</code>内存区域，指针指向并没有发生变化，还是原来那个对象，这样是没有区别的。</p><h2 id=3静态变量>3、静态变量:</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=cp>#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>@autoreleasepool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>static</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>myString</span> <span class=o>=</span> <span class=s>@&#34;111&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>myString</span> <span class=nl>stringByAppendingString</span><span class=p>:</span><span class=s>@&#34;222&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>myString</span> <span class=o>=</span> <span class=s>@&#34;444&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>myString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>myString</span> <span class=nl>stringByAppendingString</span><span class=p>:</span><span class=s>@&#34;333&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>block</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p><code>clang</code>之后的<code>C++</code>代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__block_impl</span> <span class=n>impl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__main_block_desc_0</span><span class=o>*</span> <span class=n>Desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 注意这里, 外面的静态变量被捕获了,不过捕获的是对象的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>NSString</span> <span class=o>**</span><span class=n>myString</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__main_block_impl_0</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=n>NSString</span> <span class=o>**</span><span class=n>_myString</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>myString</span><span class=p>(</span><span class=n>_myString</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>isa</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_NSConcreteStackBlock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>Flags</span> <span class=o>=</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>FuncPtr</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Desc</span> <span class=o>=</span> <span class=n>desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_func_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=o>*</span><span class=n>__cself</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>NSString</span> <span class=o>**</span><span class=n>myString</span> <span class=o>=</span> <span class=n>__cself</span><span class=o>-&gt;</span><span class=n>myString</span><span class=p>;</span> <span class=c1>// bound by copy
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过对`myString`指针进行取值操作(*myString),拿到 myString
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=p>((</span><span class=n>NSString</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>NSString</span> <span class=o>*</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)(</span><span class=o>*</span><span class=n>myString</span><span class=p>),</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;stringByAppendingString:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_dac7fc_mi_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 由下面的伪代码可以看出,由于`myString`是指针,所以通过`*`操作来获取到原来的变量,
</span></span></span><span class=line><span class=cl><span class=c1>// 然后再对其进行重新赋值操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=o>*</span><span class=n>myString</span><span class=p>)</span> <span class=o>=</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_121621_mi_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>NSLog</span><span class=p>((</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_dac7fc_mi_2</span><span class=p>,</span> <span class=p>(</span><span class=o>*</span><span class=n>myString</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_copy_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_Block_object_assign</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>dst</span><span class=o>-&gt;</span><span class=n>myString</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>myString</span><span class=p>,</span> <span class=mi>3</span><span class=cm>/*BLOCK_FIELD_IS_OBJECT*/</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_dispose_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=n>src</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_Block_object_dispose</span><span class=p>((</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=n>src</span><span class=o>-&gt;</span><span class=n>myString</span><span class=p>,</span> <span class=mi>3</span><span class=cm>/*BLOCK_FIELD_IS_OBJECT*/</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>Block_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>copy</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>dispose</span><span class=p>)(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>__main_block_desc_0_DATA</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=p>),</span> <span class=n>__main_block_copy_0</span><span class=p>,</span> <span class=n>__main_block_dispose_0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=cm>/* @autoreleasepool */</span> <span class=p>{</span> <span class=n>__AtAutoreleasePool</span> <span class=n>__autoreleasepool</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=n>NSString</span> <span class=o>*</span><span class=n>myString</span> <span class=o>=</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_dac7fc_mi_0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// block捕获的是静态变量的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=o>&amp;</span><span class=n>__main_block_impl_0</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>__main_block_func_0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>__main_block_desc_0_DATA</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>myString</span><span class=p>,</span> <span class=mi>570425344</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>((</span><span class=n>NSString</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>NSString</span> <span class=o>*</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>myString</span><span class=p>,</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;stringByAppendingString:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_dac7fc_mi_3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>))((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>FuncPtr</span><span class=p>)((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>IMAGE_INFO</span> <span class=p>{</span> <span class=kt>unsigned</span> <span class=n>version</span><span class=p>;</span> <span class=kt>unsigned</span> <span class=n>flag</span><span class=p>;</span> <span class=p>}</span> <span class=n>_OBJC_IMAGE_INFO</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span> <span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=4全局变量>4、全局变量:</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=cp>#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>NSString</span> <span class=o>*</span><span class=n>myString</span> <span class=o>=</span> <span class=s>@&#34;111&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>@autoreleasepool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>void</span><span class=p>(</span><span class=o>^</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=o>^</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>myString</span> <span class=nl>stringByAppendingString</span><span class=p>:</span><span class=s>@&#34;222&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>myString</span> <span class=o>=</span> <span class=s>@&#34;444&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>NSLog</span><span class=p>(</span><span class=s>@&#34;%@&#34;</span><span class=p>,</span> <span class=n>myString</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>myString</span> <span class=nl>stringByAppendingString</span><span class=p>:</span><span class=s>@&#34;333&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>block</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p><code>clang</code>操作执行之后的<code>C++</code>伪代码:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>NSString</span> <span class=o>*</span><span class=n>myString</span> <span class=o>=</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_938f32_mi_0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// block结构体并没有捕获全局变量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__block_impl</span> <span class=n>impl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=nc>__main_block_desc_0</span><span class=o>*</span> <span class=n>Desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__main_block_impl_0</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=o>*</span><span class=n>desc</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>isa</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_NSConcreteStackBlock</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>Flags</span> <span class=o>=</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>impl</span><span class=p>.</span><span class=n>FuncPtr</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Desc</span> <span class=o>=</span> <span class=n>desc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>__main_block_func_0</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span> <span class=o>*</span><span class=n>__cself</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 下面三个函数都是在用到全局变量`myString`的时候直接从内存去获取
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=p>((</span><span class=n>NSString</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>NSString</span> <span class=o>*</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>myString</span><span class=p>,</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;stringByAppendingString:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_938f32_mi_1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>myString</span> <span class=o>=</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_938f32_mi_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>NSLog</span><span class=p>((</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_938f32_mi_3</span><span class=p>,</span> <span class=n>myString</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>__main_block_desc_0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>reserved</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>size_t</span> <span class=n>Block_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>__main_block_desc_0_DATA</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=nc>__main_block_impl_0</span><span class=p>)};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// main函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=cm>/* @autoreleasepool */</span> <span class=p>{</span> <span class=n>__AtAutoreleasePool</span> <span class=n>__autoreleasepool</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span><span class=p>(</span><span class=o>*</span><span class=n>block</span><span class=p>)()</span> <span class=o>=</span> <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)())</span><span class=o>&amp;</span><span class=n>__main_block_impl_0</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>__main_block_func_0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>__main_block_desc_0_DATA</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>((</span><span class=n>NSString</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>id</span><span class=p>,</span> <span class=n>SEL</span><span class=p>,</span> <span class=n>NSString</span> <span class=o>*</span><span class=p>))(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>objc_msgSend</span><span class=p>)((</span><span class=n>id</span><span class=p>)</span><span class=n>myString</span><span class=p>,</span> <span class=n>sel_registerName</span><span class=p>(</span><span class=s>&#34;stringByAppendingString:&#34;</span><span class=p>),</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>__NSConstantStringImpl__var_folders_4t_ldgq93v932g220vwkl7c1fk40000gn_T_BlockTest_938f32_mi_4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>((</span><span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>))((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>FuncPtr</span><span class=p>)((</span><span class=n>__block_impl</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=nc>IMAGE_INFO</span> <span class=p>{</span> <span class=kt>unsigned</span> <span class=n>version</span><span class=p>;</span> <span class=kt>unsigned</span> <span class=n>flag</span><span class=p>;</span> <span class=p>}</span> <span class=n>_OBJC_IMAGE_INFO</span> <span class=o>=</span> <span class=p>{</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span> <span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结:</h2><h4 id=局部变量>局部变量：</h4><ul><li><p>不加<code>__block</code>: <code>block</code>内部捕获的是局部变量的值，而且如果局部变量是数值类型（比如<code>int</code>）不会有<code>__main_block_copy_0</code> 和 <code>__main_block_dispose_0</code> 两个函数，如果是引用类型（比如<code>NSArray</code>）则会有这个函数，说明对于值类型变量是直接定义新变量并赋值相同，对于引用类型变量是定义一个新变量并<code>copy</code>这个对象的指针。</p></li><li><p>添加<code>__block</code>: 原来的局部变量会被放入到一个<code>__Block_byref_变量名_0</code>类型的结构体中，然后<code>block</code>内部当捕获局部变量时其实是捕获的是这个结构体的指针，当获取原来的局部变量时(不管是在<code>block</code>内还是<code>block</code>外)，其实都是通过这个结构体或者这个结构体指针来拿到原来的局部变量再进行操作的。这也就是为什么添加<code>__block</code>后可以对<code>block</code>内捕获的局部变量进行重新赋值等操作。</p></li></ul><h4 id=静态变量>静态变量：</h4><p><code>block</code>直接捕获的是静态变量的指针，前后都是对指针进行操作。</p><h4 id=全局变量或-全局静态变量>全局变量（或 全局静态变量）：</h4><p><code>block</code>并没有捕获变量，而是在结构体的执行方法中直接使用了全局变量，是在执行时才去取值，一直都是获取变量的最新值。而且细心点我们可以发现，对于没有捕获全局变量的<code>block</code>中也没有<code>__main_block_copy_0</code> 和 <code>__main_block_dispose_0</code> 两个函数（用于在调用前后修改相应变量的引用计数），即没有发生<code>copy</code>操作。</p><h4 id=其他>其他</h4><p><code>ARC</code>环境下：在单独声明<code>block</code>的时候，<code>block</code>还是会在栈上的；当<code>block</code>作为参数返回的时候，<code>block</code>也会自动被移到堆上；在<code>ARC</code>下，只要指针过一下<code>strong</code>指针，或者由函数返回都会把<code>block</code>移动到堆上。</p><blockquote><p><code>__main_block_copy_0</code> 中的 <code>_Block_object_assign</code> 函数相当于<code>retain</code>实例方法，使 block 的成员变量持有捕获到的对象。 <code>__main_block_dispose_0</code> 中的 <code>_Block_object_dispose</code> 函数相当于 <code>release</code> 实例方法，释放 <code>block </code>的成员变量持有的对象。</p></blockquote><p><code>Objective-C</code> 中的3种<code>block</code>： <code>__NSStackBlock__</code>、<code>__NSMallocBlock</code>、<code>__NSGloballBlock</code> 会在下面的情况下出现：</p><table><thead><tr><th style=text-align:center>条件</th><th style=text-align:center>ARC</th><th style=text-align:center>MRC</th></tr></thead><tbody><tr><td style=text-align:center>捕获外部变量</td><td style=text-align:center><code>__NSStackBlock__</code><br><code>__NSMallocBlock__</code></td><td style=text-align:center><code>__NSStackBlock__</code></td></tr><tr><td style=text-align:center>未捕获外部变量</td><td style=text-align:center><code>__NSGlobalBlock__</code></td><td style=text-align:center><code>__NSGlobalBlock__</code></td></tr></tbody></table><ul><li>在 <code>ARC</code> 中，捕获了外部变量的<code>block</code>的类型会是<code>__NSStackBlock__</code> 或者 <code>__NSMallocBlock__</code>，如果 <code>block</code> 被赋值给了某个变量，在这个过程中会执行<code>_Block_copy</code>，将原有的 <code>__NSStackBlock__</code> 变成 <code>__NSMallocBlock__</code>；但是如果 <code>block</code> 没有被赋值给某个变量，那它的类型就是<code>__NSStackBlock__</code>；没有捕获外部变量的 <code>block</code> 的类则是 <code>__NSGlobalBlock__</code> ，既不在栈上，也不在堆上，它类似于 <code>C</code> 语言函数一样，会在代码段中。</li><li>在<code>MRC</code>中，捕获了外部变量的 <code>block</code> 的类会是<code>__NSStackBlock__</code>，放置在栈上；没有捕获外部变量的 <code>block</code> 与 <code>ARC</code> 环境下的情况是相同的，类型是<code>__NSGlobalBlock__</code>，放置在代码段中。</li></ul><hr><h2 id=推荐文章>推荐文章：</h2><blockquote><p>比我写的好</p></blockquote><ul><li><a href=https://github.com/pro648/tips/blob/master/sources/Block%E7%9A%84%E6%9C%AC%E8%B4%A8.md target=_blank rel="noopener noreffer">Block本质</a></li></ul><h2 id=参考文章>参考文章:</h2><ol><li><a href=http://blog.devtang.com/2013/07/28/a-look-inside-blocks/ target=_blank rel="noopener noreffer">谈Objective-C Block的实现</a></li><li><a href=http://draveness.me/block-retain-object target=_blank rel="noopener noreffer">iOS中的block是如何持有对象的</a></li><li><a href=http://www.jianshu.com/p/a5dd014edb13 target=_blank rel="noopener noreffer">深入分析Objective-C block、weakself、strongself实现原理</a></li><li><a href=http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/ target=_blank rel="noopener noreffer">block-copy</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-08-26</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://github.com/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ data-title=Block捕获原理探究 data-hashtags=iOS,block><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://github.com/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ data-hashtag=iOS><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://github.com/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ data-title=Block捕获原理探究><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://github.com/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ data-title=Block捕获原理探究><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://github.com/faimin/faimin.github.io/tree/gh-pages/block%E6%8D%95%E8%8E%B7%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/ data-title=Block捕获原理探究 data-image=/images/block/milim.jpg data-ralateuid=1655766025><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/faimin/faimin.github.io/tree/gh-pages/tags/ios/>iOS</a>,&nbsp;<a href=/faimin/faimin.github.io/tree/gh-pages/tags/block/>block</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/faimin/faimin.github.io/tree/gh-pages/>主页</a></span></section></div><div class=post-nav><a href=/faimin/faimin.github.io/tree/gh-pages/codetips/ class=prev rel=prev title=代码技巧><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>代码技巧</a>
<a href=/faimin/faimin.github.io/tree/gh-pages/promise%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90/ class=next rel=next title=Promise源码简析>Promise源码简析<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span> | <span id=busuanzi_container_site_pv>本站总访问量 <span id=busuanzi_value_site_pv></span>次</span></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.104.3">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/faimin target=_blank>Zero.D.Saber</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/faimin/faimin.github.io/tree/gh-pages/lib/valine/valine.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{valine:{appId:"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI",appKey:"WBmoGyJtbqUswvfLh6L8iEBr",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"你的评论 ...",recordIP:!0,serverURLs:"https://leancloud.hugoloveit.com",visitor:!0}},lightgallery:!0,search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.zh-cn",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script type=text/javascript src=/faimin/faimin.github.io/tree/gh-pages/js/theme.min.js></script></body></html>